name: Agent Task Flow

on:
  workflow_dispatch:
    inputs:
      task_description:
        description: 'Describe the change (e.g., Feature: Signup page)'
        required: true
        type: string
      card_id:
        description: 'Existing Trello card ID'
        required: true
        type: string

jobs:
  code-confirm:
    runs-on: ubuntu-latest
    name: Confirm code pushed (from Ready to Ship)
    environment:
      name: code-ready
    steps:
      - name: Show commit being built
        run: |
          echo "Commit: $GITHUB_SHA"
          echo "Ref: $GITHUB_REF"
      - name: Log Trello card info
        run: |
          echo "Operating on Trello card: ${{ github.event.inputs.card_id }}"
          echo "Task: ${{ github.event.inputs.task_description }}"

  test-and-build:
    runs-on: ubuntu-latest
    needs: code-confirm
    name: Test & Build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.0'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Format check (non-blocking)
        run: |
          dart format --output=none . || true

      - name: Analyze code (non-fatal warnings)
        run: dart analyze .

      - name: Run tests
        run: flutter test

      - name: Build web
        run: flutter build web --release --dart-define=FLAVOR=production

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web/
          retention-days: 7

  deploy:
    runs-on: ubuntu-latest
    needs: test-and-build
    name: Deploy to Google Cloud
    environment:
      name: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: build/web/

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          projectId: gdgcloud-480509
          channelId: live

  trello-success:
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    name: Trello -> Deployed
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Move card to Deployed
        run: node .github/scripts/trello-update.js
        env:
          TRELLO_API_KEY: ${{ secrets.TRELLO_API_KEY }}
          TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
          TRELLO_BOARD_ID: 694951faa7d6cc8841fe7bae
          TRELLO_TODO_LIST_ID: 694951faa7d6cc8841fe7be9
          TRELLO_INPROGRESS_LIST_ID: 694951faa7d6cc8841fe7bea
          TRELLO_READY_LIST_ID: 6949996bf592ed88a155869d
          TRELLO_DEPLOYED_LIST_ID: 694951faa7d6cc8841fe7beb
          BUILD_STATUS: deployed
          TASK_DESCRIPTION: ${{ github.event.inputs.task_description }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_ACTOR: ${{ github.actor }}
          CARD_ID: ${{ github.event.inputs.card_id }}

  trello-failure:
    runs-on: ubuntu-latest
    needs: [deploy, test-and-build]
    if: failure()
    name: Trello -> Failure
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Move card to In Progress (failure)
        run: node .github/scripts/trello-update.js
        env:
          TRELLO_API_KEY: ${{ secrets.TRELLO_API_KEY }}
          TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
          TRELLO_BOARD_ID: 694951faa7d6cc8841fe7bae
          TRELLO_TODO_LIST_ID: 694951faa7d6cc8841fe7be9
          TRELLO_INPROGRESS_LIST_ID: 694951faa7d6cc8841fe7bea
          TRELLO_READY_LIST_ID: 6949996bf592ed88a155869d
          TRELLO_DEPLOYED_LIST_ID: 694951faa7d6cc8841fe7beb
          BUILD_STATUS: failure
          TASK_DESCRIPTION: ${{ github.event.inputs.task_description }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_ACTOR: ${{ github.actor }}
          CARD_ID: ${{ github.event.inputs.card_id }}

  notify-success:
    runs-on: ubuntu-latest
    needs: trello-success
    if: success()
    name: Email -> Deployed
    steps:
      - name: Send success email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Deployed: ${{ github.event.inputs.task_description }}"
          to: ${{ secrets.NOTIFY_EMAIL_TO }}
          from: ${{ secrets.NOTIFY_EMAIL_FROM }}
          body: |
            Status: Deployed
            Card: ${{ github.event.inputs.task_description }} (ID: ${{ github.event.inputs.card_id }})
            Commit: ${{ github.sha }}
            Ref: ${{ github.ref }}
            Actor: ${{ github.actor }}

  notify-failure:
    runs-on: ubuntu-latest
    needs: trello-failure
    if: always() && needs.trello-failure.result == 'failure'
    name: Email -> Failure
    steps:
      - name: Send failure email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Failed: ${{ github.event.inputs.task_description }}"
          to: ${{ secrets.NOTIFY_EMAIL_TO }}
          from: ${{ secrets.NOTIFY_EMAIL_FROM }}
          body: |
            Status: Failed
            Card: ${{ github.event.inputs.task_description }} (ID: ${{ github.event.inputs.card_id }})
            Commit: ${{ github.sha }}
            Ref: ${{ github.ref }}
            Actor: ${{ github.actor }}
