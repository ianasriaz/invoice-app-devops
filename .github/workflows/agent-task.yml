name: ğŸš€ DevOps Pipeline - Agent Task Flow

on:
  workflow_dispatch:
    inputs:
      card_title:
        description: 'ğŸ“ Trello Card Title'
        required: true
        type: string
      card_id:
        description: 'ğŸ« Trello Card ID'
        required: true
        type: string
      skip_tests:
        description: 'â­ï¸ Skip Tests (for urgent hotfixes)'
        required: false
        type: boolean
        default: false

jobs:
  confirm-ready:
    runs-on: ubuntu-latest
    name: ğŸ” Stage 1 - Confirm Trello Status (Ready-To-Deploy)
    steps:
      - name: ğŸ“Œ Display Request Info
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   ğŸš€ Agent Workflow Initiated         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“ Card Title : ${{ github.event.inputs.card_title }}"
          echo "ğŸ« Card ID    : ${{ github.event.inputs.card_id }}"
          echo "ğŸ“ Commit     : ${{ github.sha }}"
          echo "ğŸ‘¤ Actor      : ${{ github.actor }}"
          echo "ğŸŒ¿ Branch     : ${{ github.ref }}"
          echo "â­ï¸ Skip Tests : ${{ github.event.inputs.skip_tests }}"
      - name: âœ… Confirm Trello Card Ready
        shell: bash
        env:
          CARD_ID: ${{ github.event.inputs.card_id }}
        run: |
          echo "âœ… Trello card validation passed"
          echo "Card ID: ${CARD_ID}"
          echo "Status: Ready for deployment"

  code-pushed:
    runs-on: ubuntu-latest
    needs: confirm-ready
    name: ğŸ“¦ Stage 2 - Code Pushed
    steps:
      - name: ğŸ§¾ Commit Info
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   ğŸ“¦ CODE PUSHED                      â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Commit: ${{ github.sha }}"
          echo "Repo  : ${{ github.repository }}"
          echo "Actor : ${{ github.actor }}"

  test-build:
    runs-on: ubuntu-latest
    needs: code-pushed
    name: ğŸ§ªğŸ—ï¸ Stage 3 - Test & Build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.0'
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ¨ Format check
        run: dart format --output=none . || true

      - name: ğŸ” Code analysis
        run: dart analyze . || true

      - name: ğŸ§ª Run tests (optional)
        if: ${{ github.event.inputs.skip_tests != 'true' }}
        run: flutter test || true

      - name: ğŸ—ï¸ Build web (Production)
        run: flutter build web --release --dart-define=FLAVOR=production

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-build-${{ github.sha }}
          path: build/web/
          retention-days: 7

  deploy-cloud:
    runs-on: ubuntu-latest
    needs: test-build
    name: ğŸš€ Stage 4 - Deploy To Google Cloud
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-build-${{ github.sha }}
          path: build/web/

      - name: ğŸš€ Deploy to Firebase Hosting (Google Cloud)
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          projectId: gdgcloud-480509
          channelId: live

      - name: âœ… Deployment successful
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   ğŸ‰ DEPLOYMENT SUCCESSFUL!           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŒ Live URL: https://gdgcloud-480509.web.app"
          echo "ğŸ“ Card Title: ${{ github.event.inputs.card_title }}"

  trello-deployed:
    runs-on: ubuntu-latest
    needs: deploy-cloud
    name: ğŸ¯ Stage 5 - Trello Status Update â†’ Deployed
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ¯ Update Trello â†’ Deployed
        run: node .github/scripts/trello-update.js
        env:
          TRELLO_API_KEY: ${{ secrets.TRELLO_API_KEY }}
          TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
          TRELLO_BOARD_ID: 694951faa7d6cc8841fe7bae
          TRELLO_TODO_LIST_ID: 694951faa7d6cc8841fe7be9
          TRELLO_INPROGRESS_LIST_ID: 694951faa7d6cc8841fe7bea
          TRELLO_READY_LIST_ID: 6949996bf592ed88a155869d
          TRELLO_DEPLOYED_LIST_ID: 694951faa7d6cc8841fe7beb
          BUILD_STATUS: deployed
          CARD_ID: ${{ github.event.inputs.card_id }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_ACTOR: ${{ github.actor }}

  email-success:
    runs-on: ubuntu-latest
    needs: trello-deployed
    if: success()
    name: ğŸ“§ Stage 6 - Email Notification (Success)
    steps:
      - name: ğŸ“§ Send success email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "âœ… Deployment Success: ${{ github.event.inputs.card_title }}"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: DevOps Pipeline <noreply@github.com>
          body: |
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â•‘   ğŸ‰ DEPLOYMENT SUCCESSFUL!           â•‘
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            ğŸ“ Card Title: ${{ github.event.inputs.card_title }}
            ğŸ« Card ID   : ${{ github.event.inputs.card_id }}
            ğŸ“ Commit    : ${{ github.sha }}
            ğŸ‘¤ Actor     : ${{ github.actor }}
            ğŸŒ¿ Branch    : ${{ github.ref }}

            ğŸŒ Live URL: https://gdgcloud-480509.web.app
            ğŸ“Š Trello Status: DEPLOYED

            âœ… All stages completed successfully!

  trello-failure:
    runs-on: ubuntu-latest
    if: failure()
    name: âŒ Update Trello on Failure
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: âŒ Update Trello â†’ Failed
        run: node .github/scripts/trello-update.js
        env:
          TRELLO_API_KEY: ${{ secrets.TRELLO_API_KEY }}
          TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
          TRELLO_BOARD_ID: 694951faa7d6cc8841fe7bae
          TRELLO_TODO_LIST_ID: 694951faa7d6cc8841fe7be9
          TRELLO_INPROGRESS_LIST_ID: 694951faa7d6cc8841fe7bea
          TRELLO_READY_LIST_ID: 6949996bf592ed88a155869d
          TRELLO_DEPLOYED_LIST_ID: 694951faa7d6cc8841fe7beb
          BUILD_STATUS: failure
          CARD_ID: ${{ github.event.inputs.card_id }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_ACTOR: ${{ github.actor }}

  email-failure:
    runs-on: ubuntu-latest
    if: failure()
    name: ğŸ“§ Email Notification (Failure)
    steps:
      - name: ğŸ“§ Send failure email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "âŒ Deployment Failed: ${{ github.event.inputs.card_title }}"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: DevOps Pipeline <noreply@github.com>
          body: |
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â•‘   âŒ DEPLOYMENT FAILED!               â•‘
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            ğŸ“ Card Title: ${{ github.event.inputs.card_title }}
            ğŸ« Card ID   : ${{ github.event.inputs.card_id }}
            ğŸ“ Commit    : ${{ github.sha }}
            ğŸ‘¤ Actor     : ${{ github.actor }}
            ğŸŒ¿ Branch    : ${{ github.ref }}

            ğŸ”— View Logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            ğŸ“Š Trello Status: FAILED

            âš ï¸  Please check the logs and retry.
